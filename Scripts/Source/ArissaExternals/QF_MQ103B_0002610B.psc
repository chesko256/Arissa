;BEGIN FRAGMENT CODE - Do not edit anything between this and the end comment
;NEXT FRAGMENT INDEX 74
Scriptname QF_MQ103B_0002610B Extends Quest Hidden

;BEGIN ALIAS PROPERTY FriendlyFollower01
;ALIAS PROPERTY TYPE referencealias
referencealias Property Alias_FriendlyFollower01 Auto
;END ALIAS PROPERTY

;BEGIN ALIAS PROPERTY ExteriorDefender1
;ALIAS PROPERTY TYPE referencealias
referencealias Property Alias_ExteriorDefender1 Auto
;END ALIAS PROPERTY

;BEGIN ALIAS PROPERTY KorvanjundMeetingPoint
;ALIAS PROPERTY TYPE referencealias
referencealias Property Alias_KorvanjundMeetingPoint Auto
;END ALIAS PROPERTY

;BEGIN ALIAS PROPERTY ObjDraugr01
;ALIAS PROPERTY TYPE referencealias
referencealias Property Alias_ObjDraugr01 Auto
;END ALIAS PROPERTY

;BEGIN ALIAS PROPERTY EnemyEavesdrop01a
;ALIAS PROPERTY TYPE referencealias
referencealias Property Alias_EnemyEavesdrop01a Auto
;END ALIAS PROPERTY

;BEGIN ALIAS PROPERTY ObjDraugr04
;ALIAS PROPERTY TYPE referencealias
referencealias Property Alias_ObjDraugr04 Auto
;END ALIAS PROPERTY

;BEGIN ALIAS PROPERTY ExteriorDefender4
;ALIAS PROPERTY TYPE referencealias
referencealias Property Alias_ExteriorDefender4 Auto
;END ALIAS PROPERTY

;BEGIN ALIAS PROPERTY FriendlyFollower04
;ALIAS PROPERTY TYPE referencealias
referencealias Property Alias_FriendlyFollower04 Auto
;END ALIAS PROPERTY

;BEGIN ALIAS PROPERTY LockedGateLever02
;ALIAS PROPERTY TYPE referencealias
referencealias Property Alias_LockedGateLever02 Auto
;END ALIAS PROPERTY

;BEGIN ALIAS PROPERTY Cell01ExitDoor
;ALIAS PROPERTY TYPE referencealias
referencealias Property Alias_Cell01ExitDoor Auto
;END ALIAS PROPERTY

;BEGIN ALIAS PROPERTY BookMarker
;ALIAS PROPERTY TYPE referencealias
referencealias Property Alias_BookMarker Auto
;END ALIAS PROPERTY

;BEGIN ALIAS PROPERTY Cell02ExitDoor
;ALIAS PROPERTY TYPE referencealias
referencealias Property Alias_Cell02ExitDoor Auto
;END ALIAS PROPERTY

;BEGIN ALIAS PROPERTY Ulfric
;ALIAS PROPERTY TYPE referencealias
referencealias Property Alias_Ulfric Auto
;END ALIAS PROPERTY

;BEGIN ALIAS PROPERTY Sifnar
;ALIAS PROPERTY TYPE referencealias
referencealias Property Alias_Sifnar Auto
;END ALIAS PROPERTY

;BEGIN ALIAS PROPERTY Book
;ALIAS PROPERTY TYPE referencealias
referencealias Property Alias_Book Auto
;END ALIAS PROPERTY

;BEGIN ALIAS PROPERTY DeadDraugrHeadTarget
;ALIAS PROPERTY TYPE referencealias
referencealias Property Alias_DeadDraugrHeadTarget Auto
;END ALIAS PROPERTY

;BEGIN ALIAS PROPERTY ExteriorDefender5
;ALIAS PROPERTY TYPE referencealias
referencealias Property Alias_ExteriorDefender5 Auto
;END ALIAS PROPERTY

;BEGIN ALIAS PROPERTY ObjDraugr05
;ALIAS PROPERTY TYPE referencealias
referencealias Property Alias_ObjDraugr05 Auto
;END ALIAS PROPERTY

;BEGIN ALIAS PROPERTY Stage61EntranceMarker01
;ALIAS PROPERTY TYPE referencealias
referencealias Property Alias_Stage61EntranceMarker01 Auto
;END ALIAS PROPERTY

;BEGIN ALIAS PROPERTY ScoutsManyMarshes
;ALIAS PROPERTY TYPE referencealias
referencealias Property Alias_ScoutsManyMarshes Auto
;END ALIAS PROPERTY

;BEGIN ALIAS PROPERTY PreQuestDungeonDisabler
;ALIAS PROPERTY TYPE referencealias
referencealias Property Alias_PreQuestDungeonDisabler Auto
;END ALIAS PROPERTY

;BEGIN ALIAS PROPERTY GeneralTullius
;ALIAS PROPERTY TYPE referencealias
referencealias Property Alias_GeneralTullius Auto
;END ALIAS PROPERTY

;BEGIN ALIAS PROPERTY ObjDraugr06
;ALIAS PROPERTY TYPE referencealias
referencealias Property Alias_ObjDraugr06 Auto
;END ALIAS PROPERTY

;BEGIN ALIAS PROPERTY Galmar
;ALIAS PROPERTY TYPE referencealias
referencealias Property Alias_Galmar Auto
;END ALIAS PROPERTY

;BEGIN ALIAS PROPERTY ObjDraugr03
;ALIAS PROPERTY TYPE referencealias
referencealias Property Alias_ObjDraugr03 Auto
;END ALIAS PROPERTY

;BEGIN ALIAS PROPERTY FriendlyFollower03
;ALIAS PROPERTY TYPE referencealias
referencealias Property Alias_FriendlyFollower03 Auto
;END ALIAS PROPERTY

;BEGIN ALIAS PROPERTY ExteriorDefender3
;ALIAS PROPERTY TYPE referencealias
referencealias Property Alias_ExteriorDefender3 Auto
;END ALIAS PROPERTY

;BEGIN ALIAS PROPERTY DraugrBossMinion02
;ALIAS PROPERTY TYPE referencealias
referencealias Property Alias_DraugrBossMinion02 Auto
;END ALIAS PROPERTY

;BEGIN ALIAS PROPERTY CaptainMetilius
;ALIAS PROPERTY TYPE referencealias
referencealias Property Alias_CaptainMetilius Auto
;END ALIAS PROPERTY

;BEGIN ALIAS PROPERTY EnemyEavesdrop01b
;ALIAS PROPERTY TYPE referencealias
referencealias Property Alias_EnemyEavesdrop01b Auto
;END ALIAS PROPERTY

;BEGIN ALIAS PROPERTY Korvanjund
;ALIAS PROPERTY TYPE locationalias
locationalias Property Alias_Korvanjund Auto
;END ALIAS PROPERTY

;BEGIN ALIAS PROPERTY Torsten
;ALIAS PROPERTY TYPE referencealias
referencealias Property Alias_Torsten Auto
;END ALIAS PROPERTY

;BEGIN ALIAS PROPERTY Stage61EntranceMarker02
;ALIAS PROPERTY TYPE referencealias
referencealias Property Alias_Stage61EntranceMarker02 Auto
;END ALIAS PROPERTY

;BEGIN ALIAS PROPERTY FriendlyFollower02
;ALIAS PROPERTY TYPE referencealias
referencealias Property Alias_FriendlyFollower02 Auto
;END ALIAS PROPERTY

;BEGIN ALIAS PROPERTY Ralof
;ALIAS PROPERTY TYPE referencealias
referencealias Property Alias_Ralof Auto
;END ALIAS PROPERTY

;BEGIN ALIAS PROPERTY DraugrBoss
;ALIAS PROPERTY TYPE referencealias
referencealias Property Alias_DraugrBoss Auto
;END ALIAS PROPERTY

;BEGIN ALIAS PROPERTY EbonyClaw
;ALIAS PROPERTY TYPE referencealias
referencealias Property Alias_EbonyClaw Auto
;END ALIAS PROPERTY

;BEGIN ALIAS PROPERTY 03WarpMarker
;ALIAS PROPERTY TYPE referencealias
referencealias Property Alias_03WarpMarker Auto
;END ALIAS PROPERTY

;BEGIN ALIAS PROPERTY ExteriorDefender2
;ALIAS PROPERTY TYPE referencealias
referencealias Property Alias_ExteriorDefender2 Auto
;END ALIAS PROPERTY

;BEGIN ALIAS PROPERTY Cell02FriendlyMoveToPoint
;ALIAS PROPERTY TYPE referencealias
referencealias Property Alias_Cell02FriendlyMoveToPoint Auto
;END ALIAS PROPERTY

;BEGIN ALIAS PROPERTY DraugrBossMinion01
;ALIAS PROPERTY TYPE referencealias
referencealias Property Alias_DraugrBossMinion01 Auto
;END ALIAS PROPERTY

;BEGIN ALIAS PROPERTY ObjDraugr02
;ALIAS PROPERTY TYPE referencealias
referencealias Property Alias_ObjDraugr02 Auto
;END ALIAS PROPERTY

;BEGIN FRAGMENT Fragment_20
Function Fragment_20()
;BEGIN AUTOCAST TYPE MQ103QuestScript
Quest __temp = self as Quest
MQ103QuestScript kmyQuest = __temp as MQ103QuestScript
;END AUTOCAST
;BEGIN CODE
; player has gotten the book for the Sons of Skyrim
SetObjectiveCompleted(40)

Alias_Ralof.GetActorReference().AddToFaction(kmyquest.CWBuddies)

SetObjectiveDisplayed(80)
; disable Sifnar (for MQ104B)
;Alias_Sifnar.TryToDisable()
UnregisterForUpdate()
;END CODE
EndFunction
;END FRAGMENT

;BEGIN FRAGMENT Fragment_30
Function Fragment_30()
;BEGIN AUTOCAST TYPE MQ103QuestScript
Quest __temp = self as Quest
MQ103QuestScript kmyQuest = __temp as MQ103QuestScript
;END AUTOCAST
;BEGIN CODE
; debug.trace("CW02B Stage 220")

; player brings crown to Tullius instead of Ulfric
Game.GetPlayer().removeitem(Alias_Book.GetReference(), 1)
SetObjectiveFailed(80)
SetObjectiveDisplayed(90)

; player joins Imperials
CW.SetStage(11)

kmyquest.CW03.setstage(10)
;END CODE
EndFunction
;END FRAGMENT

;BEGIN FRAGMENT Fragment_40
Function Fragment_40()
;BEGIN CODE
;Player, and friends, have defeated all the draugr in the draugr room
;END CODE
EndFunction
;END FRAGMENT

;BEGIN FRAGMENT Fragment_50
Function Fragment_50()
;BEGIN CODE
; player hits first trigger in interior, or starts combat with defenders
;END CODE
EndFunction
;END FRAGMENT

;BEGIN FRAGMENT Fragment_70
Function Fragment_70()
;BEGIN CODE
;Gets set when the player is close enough, or has bypassed, the ambush area
;END CODE
EndFunction
;END FRAGMENT

;BEGIN FRAGMENT Fragment_55
Function Fragment_55()
;BEGIN CODE
; trigger boss Minions
Alias_DraugrBossMinion01.GetReference().Activate(Alias_DraugrBossMinion01.GetReference())
utility.wait(0.78)
Alias_DraugrBossMinion02.GetReference().Activate(Alias_DraugrBossMinion02.GetReference())
;END CODE
EndFunction
;END FRAGMENT

;BEGIN FRAGMENT Fragment_35
Function Fragment_35()
;BEGIN CODE
;Player has picked up Ebony Claw
;END CODE
EndFunction
;END FRAGMENT

;BEGIN FRAGMENT Fragment_0
Function Fragment_0()
;BEGIN CODE
SetStage(1)
;END CODE
EndFunction
;END FRAGMENT

;BEGIN FRAGMENT Fragment_15
Function Fragment_15()
;BEGIN CODE
; all defenders are dead
;SetObjectiveCompleted (30)
;SetObjectiveDisplayed (40)
;END CODE
EndFunction
;END FRAGMENT

;BEGIN FRAGMENT Fragment_61
Function Fragment_61()
;BEGIN CODE
;Player is ready to enter, or has entered, the HOS
;END CODE
EndFunction
;END FRAGMENT

;BEGIN FRAGMENT Fragment_4
Function Fragment_4()
;BEGIN CODE
setObjectiveDisplayed(10)
GalmarScene.Start()
;END CODE
EndFunction
;END FRAGMENT

;BEGIN FRAGMENT Fragment_11
Function Fragment_11()
;BEGIN AUTOCAST TYPE MQ103QuestScript
Quest __temp = self as Quest
MQ103QuestScript kmyQuest = __temp as MQ103QuestScript
;END AUTOCAST
;BEGIN CODE
; player leaves headquarters
Alias_Galmar.GetReference().moveto(KorvanjundMeetingPoint)
; failsafe
GalmarScene.Stop()
kmyQuest.ExteriorIntro.Start()
;END CODE
EndFunction
;END FRAGMENT

;BEGIN FRAGMENT Fragment_34
Function Fragment_34()
;BEGIN CODE
;Player is told to open HOS Door
;END CODE
EndFunction
;END FRAGMENT

;BEGIN FRAGMENT Fragment_24
Function Fragment_24()
;BEGIN CODE
; debug.trace("CW02B Stage 200")

CompleteAllObjectives()
; release reservation of Korvanjund
KorvanjundReserved.Clear()

SonsAttackEnableMarker.disable()

Stop()
;END CODE
EndFunction
;END FRAGMENT

;BEGIN FRAGMENT Fragment_54
Function Fragment_54()
;BEGIN CODE
; player picked up book
SetStage(180)
;utility.wait(3)
; trigger boss
;setStage(174)
;END CODE
EndFunction
;END FRAGMENT

;BEGIN FRAGMENT Fragment_44
Function Fragment_44()
;BEGIN CODE
; Galmar arrives at meeting point
;END CODE
EndFunction
;END FRAGMENT

;BEGIN FRAGMENT Fragment_37
Function Fragment_37()
;BEGIN CODE
;Player opens the Hall of Stories door.
;END CODE
EndFunction
;END FRAGMENT

;BEGIN FRAGMENT Fragment_59
Function Fragment_59()
;BEGIN AUTOCAST TYPE MQ103QuestScript
Quest __temp = self as Quest
MQ103QuestScript kmyQuest = __temp as MQ103QuestScript
;END AUTOCAST
;BEGIN CODE
;Triggered at end of first phase of Attack 03 scene, forcing friendlies to move into cell 02

Alias_EnemyEavesdrop01a.GetActorReference().Kill()
Alias_EnemyEavesdrop01b.GetActorReference().Kill()

kmyQuest.InteriorAttack.Stop()
kmyQuest.InteriorAttack02.Stop()
kmyQuest.MQ103aInteriorAttack03.Start()

if (Game.GetPlayer().GetParentCell() != Alias_Galmar.GetReference().GetParentCell())
	(Alias_Galmar.GetActorReference().GetCombatTarget()).Kill()
	Alias_Galmar.GetActorReference().StopCombat()
	Alias_Galmar.GetReference().MoveTo(Alias_Cell02FriendlyMoveToPoint.GetReference())
	Alias_Galmar.GetActorReference().EvaluatePackage()
endif

if Alias_Ralof.GetActorReference().IsDead() == 0 && (Game.GetPlayer().GetParentCell() != Alias_Ralof.GetReference().GetParentCell())
	(Alias_Ralof.GetActorReference().GetCombatTarget()).Kill()
	Alias_Ralof.GetActorReference().StopCombat()
	Alias_Ralof.GetReference().MoveTo(Alias_Cell02FriendlyMoveToPoint.GetReference())
	Alias_Ralof.GetActorReference().EvaluatePackage()
endif

if Alias_FriendlyFollower01.GetActorReference().IsDead() == 0 && (Game.GetPlayer().GetParentCell() != Alias_FriendlyFollower01.GetReference().GetParentCell())
	(Alias_FriendlyFollower01.GetActorReference().GetCombatTarget()).Kill()
	Alias_FriendlyFollower01.GetActorReference().StopCombat()
	Alias_FriendlyFollower01.GetReference().MoveTo(Alias_Cell02FriendlyMoveToPoint.GetReference())
	Alias_FriendlyFollower01.GetActorReference().EvaluatePackage()
endif

if Alias_FriendlyFollower02.GetActorReference().IsDead() == 0 && (Game.GetPlayer().GetParentCell() != Alias_FriendlyFollower02.GetReference().GetParentCell())
	(Alias_FriendlyFollower02.GetActorReference().GetCombatTarget()).Kill()
	Alias_FriendlyFollower02.GetActorReference().StopCombat()
	Alias_FriendlyFollower02.GetReference().MoveTo(Alias_Cell02FriendlyMoveToPoint.GetReference())
	Alias_FriendlyFollower02.GetActorReference().EvaluatePackage()
endif
;END CODE
EndFunction
;END FRAGMENT

;BEGIN FRAGMENT Fragment_17
Function Fragment_17()
;BEGIN CODE
;SetObjectiveDisplayed(50) ;DISPLAY Find a way to open the gate
;END CODE
EndFunction
;END FRAGMENT

;BEGIN FRAGMENT Fragment_67
Function Fragment_67()
;BEGIN CODE
; trigger boss
Alias_DraugrBoss.GetReference().Activate(Alias_DraugrBoss.GetReference())
;END CODE
EndFunction
;END FRAGMENT

;BEGIN FRAGMENT Fragment_57
Function Fragment_57()
;BEGIN CODE
;Gets triggered when the player gets near the korvanjund exterior door.  For deciding if Galmar
;  and friends should wait for the player or not.
;END CODE
EndFunction
;END FRAGMENT

;BEGIN FRAGMENT Fragment_39
Function Fragment_39()
;BEGIN CODE
;Player opens door out of draugr room, also unleashes the sleeping draugr
;END CODE
EndFunction
;END FRAGMENT

;BEGIN FRAGMENT Fragment_42
Function Fragment_42()
;BEGIN CODE
; defenders aggro on player before he talks to Galmar
SetStage(50)
;END CODE
EndFunction
;END FRAGMENT

;BEGIN FRAGMENT Fragment_52
Function Fragment_52()
;BEGIN CODE
; draugr boss is dead
;END CODE
EndFunction
;END FRAGMENT

;BEGIN FRAGMENT Fragment_62
Function Fragment_62()
;BEGIN AUTOCAST TYPE MQ103QuestScript
Quest __temp = self as Quest
MQ103QuestScript kmyQuest = __temp as MQ103QuestScript
;END AUTOCAST
;BEGIN CODE
;LockedGate01.disable()
;SetObjectiveCompleted(50) ;COMPLETE Find a way to open the gate
Alias_EnemyEavesdrop01a.GetActorRef().RemoveFromFaction(MQ103DefenderFaction)
Alias_EnemyEavesdrop01b.GetActorRef().RemoveFromFaction(MQ103DefenderFaction)
Alias_EnemyEavesdrop01a.GetActorRef().AddToFaction(MQ103DefenderFaction)
Alias_EnemyEavesdrop01b.GetActorRef().AddToFaction(MQ103DefenderFaction)
;END CODE
EndFunction
;END FRAGMENT

;BEGIN FRAGMENT Fragment_72
Function Fragment_72()
;BEGIN AUTOCAST TYPE MQ103QuestScript
Quest __temp = self as Quest
MQ103QuestScript kmyQuest = __temp as MQ103QuestScript
;END AUTOCAST
;BEGIN CODE
;Player has entered the book room.  Warping friendlies to him if they aren't already in this cell, and are alive.

Alias_ObjDraugr01.GetActorReference().Kill()
Alias_ObjDraugr02.GetActorReference().Kill()
Alias_ObjDraugr03.GetActorReference().Kill()
Alias_ObjDraugr04.GetActorReference().Kill()
Alias_ObjDraugr05.GetActorReference().Kill()
Alias_ObjDraugr06.GetActorReference().Kill()

kmyQuest.InteriorAttack.Stop()
kmyQuest.InteriorAttack02.Stop()
kmyQuest.MQ103aInteriorAttack03.Stop()
kmyQuest.MQ103aBookRoom.Start()

if (Game.GetPlayer().GetParentCell() != Alias_Galmar.GetReference().GetParentCell())
	Alias_Galmar.GetReference().MoveTo(Alias_03WarpMarker.GetReference())
	Alias_Galmar.GetActorReference().EvaluatePackage()
endif

if Alias_Ralof.GetActorReference().IsDead() == 0 && (Game.GetPlayer().GetParentCell() != Alias_Ralof.GetReference().GetParentCell())
	Alias_Ralof.GetReference().MoveTo(Alias_03WarpMarker.GetReference())
	Alias_Ralof.GetActorReference().EvaluatePackage()
endif

if Alias_FriendlyFollower01.GetActorReference().IsDead() == 0 && (Game.GetPlayer().GetParentCell() != Alias_FriendlyFollower01.GetReference().GetParentCell())
	Alias_FriendlyFollower01.GetReference().MoveTo(Alias_03WarpMarker.GetReference())
	Alias_FriendlyFollower01.GetActorReference().EvaluatePackage()
endif

if Alias_FriendlyFollower02.GetActorReference().IsDead() == 0 && (Game.GetPlayer().GetParentCell() != Alias_FriendlyFollower02.GetReference().GetParentCell())
	Alias_FriendlyFollower02.GetReference().MoveTo(Alias_03WarpMarker.GetReference())
	Alias_FriendlyFollower02.GetActorReference().EvaluatePackage()
endif
;END CODE
EndFunction
;END FRAGMENT

;BEGIN FRAGMENT Fragment_22
Function Fragment_22()
;BEGIN AUTOCAST TYPE MQ103QuestScript
Quest __temp = self as Quest
MQ103QuestScript kmyQuest = __temp as MQ103QuestScript
;END AUTOCAST
;BEGIN CODE
; debug.trace("CW02B Stage 190")

; player speaks to Ulfric
Game.GetPlayer().removeitem(Alias_Book.GetReference(), 1)
SetObjectiveCompleted (80)
SetObjectiveDisplayed(90)
; start transition scene
;MQ104B.setstage(10)

kmyquest.CW03.setstage(10)
;END CODE
EndFunction
;END FRAGMENT

;BEGIN FRAGMENT Fragment_28
Function Fragment_28()
;BEGIN CODE
; Galmar has reached the book chamber
;END CODE
EndFunction
;END FRAGMENT

;BEGIN FRAGMENT Fragment_38
Function Fragment_38()
;BEGIN CODE
;Player is told to open the locked gate
;END CODE
EndFunction
;END FRAGMENT

;BEGIN FRAGMENT Fragment_66
Function Fragment_66()
;BEGIN CODE
;Player has entered book room
;END CODE
EndFunction
;END FRAGMENT

;BEGIN FRAGMENT Fragment_68
Function Fragment_68()
;BEGIN AUTOCAST TYPE MQ103QuestScript
Quest __temp = self as Quest
MQ103QuestScript kmyQuest = __temp as MQ103QuestScript
;END AUTOCAST
;BEGIN CODE
;Failsafe to make sure they are all activated, and attacking
Alias_DraugrBoss.GetReference().Activate(Alias_DraugrBoss.GetReference())
Alias_DraugrBossMinion01.GetReference().Activate(Alias_DraugrBossMinion01.GetReference())
Alias_DraugrBossMinion02.GetReference().Activate(Alias_DraugrBossMinion02.GetReference())
Alias_DraugrBoss.GetActorReference().RemoveFromFaction(kmyquest.DunPrisonerFaction)
Alias_DraugrBossMinion01.GetActorReference().RemoveFromFaction(kmyquest.DunPrisonerFaction)
Alias_DraugrBossMinion02.GetActorReference().RemoveFromFaction(kmyquest.DunPrisonerFaction)
;END CODE
EndFunction
;END FRAGMENT

;BEGIN FRAGMENT Fragment_46
Function Fragment_46()
;BEGIN CODE
; Ralof greets player at Korvanjund
;END CODE
EndFunction
;END FRAGMENT

;BEGIN FRAGMENT Fragment_48
Function Fragment_48()
;BEGIN CODE
; Galmar hits trigger in first big room
;END CODE
EndFunction
;END FRAGMENT

;BEGIN FRAGMENT Fragment_26
Function Fragment_26()
;BEGIN CODE
; trigger eavesdrop scene
;END CODE
EndFunction
;END FRAGMENT

;BEGIN FRAGMENT Fragment_6
Function Fragment_6()
;BEGIN CODE
; finished first part of Galmar conversation
;END CODE
EndFunction
;END FRAGMENT

;BEGIN FRAGMENT Fragment_58
Function Fragment_58()
;BEGIN CODE
;Make sure enemies outside are dead, in case player skipped ahead.
Alias_ExteriorDefender1.GetActorReference().Kill()
Alias_ExteriorDefender2.GetActorReference().Kill()
Alias_ExteriorDefender3.GetActorReference().Kill()
Alias_ExteriorDefender4.GetActorReference().Kill()
Alias_ExteriorDefender5.GetActorReference().Kill()

Alias_Galmar.GetReference().MoveTo(Alias_Stage61EntranceMarker01.GetReference())
Alias_Galmar.GetActorReference().EvaluatePackage()

if Alias_Ralof.GetActorReference().IsDead() == 0
	Alias_Ralof.GetReference().MoveTo(Alias_Stage61EntranceMarker02.GetReference())
	Alias_Ralof.GetActorReference().EvaluatePackage()
endif

if Alias_FriendlyFollower01.GetActorReference().IsDead() == 0
	Alias_FriendlyFollower01.GetReference().MoveTo(Alias_Stage61EntranceMarker01.GetReference())
	Alias_FriendlyFollower01.GetActorReference().EvaluatePackage()
endif

if Alias_FriendlyFollower02.GetActorReference().IsDead() == 0
	Alias_FriendlyFollower02.GetReference().MoveTo(Alias_Stage61EntranceMarker02.GetReference())
	Alias_FriendlyFollower02.GetActorReference().EvaluatePackage()
endif

if Alias_FriendlyFollower03.GetActorReference().IsDead() == 0
	Alias_FriendlyFollower03.GetReference().MoveTo(Alias_Stage61EntranceMarker01.GetReference())
	Alias_FriendlyFollower03.GetActorReference().EvaluatePackage()
endif

if Alias_FriendlyFollower04.GetActorReference().IsDead() == 0
	Alias_FriendlyFollower04.GetReference().MoveTo(Alias_Stage61EntranceMarker02.GetReference())
	Alias_FriendlyFollower04.GetActorReference().EvaluatePackage()
endif

SetStage(60)
;END CODE
EndFunction
;END FRAGMENT

;BEGIN FRAGMENT Fragment_36
Function Fragment_36()
;BEGIN CODE
;Player tried open the door with the wrong combination.  Stage only sets the first time the player does it.
;END CODE
EndFunction
;END FRAGMENT

;BEGIN FRAGMENT Fragment_13
Function Fragment_13()
;BEGIN AUTOCAST TYPE MQ103QuestScript
Quest __temp = self as Quest
MQ103QuestScript kmyQuest = __temp as MQ103QuestScript
;END AUTOCAST
;BEGIN CODE
; debug.trace(self + "STAGE 50")

; begin attack on Korvanjund
SetObjectiveCompleted(20)
;SetObjectiveDisplayed(30)
SetObjectiveDisplayed(40)
; make enemies of player
MQ103DefenderFaction.SetEnemy(PlayerFaction)
; remove all temporary friend factions
Alias_ExteriorDefender1.GetActorRef().RemoveFromFaction(TempFriendsFaction)
Alias_ExteriorDefender2.GetActorRef().RemoveFromFaction(TempFriendsFaction)
Alias_ExteriorDefender3.GetActorRef().RemoveFromFaction(TempFriendsFaction)
Alias_ExteriorDefender4.GetActorRef().RemoveFromFaction(TempFriendsFaction)
Alias_ExteriorDefender5.GetActorRef().RemoveFromFaction(TempFriendsFaction)


; start attack scene
; debug.trace(self + "STAGE 50 - trying to stop ExteriorIntro scene")
kmyQuest.ExteriorIntro.Stop()

; debug.trace(self + "STAGE 50 - trying to start ExteriorAttack scene")
kmyQuest.ExteriorAttack.Start()
;END CODE
EndFunction
;END FRAGMENT

;BEGIN FRAGMENT Fragment_63
Function Fragment_63()
;BEGIN AUTOCAST TYPE MQ103QuestScript
Quest __temp = self as Quest
MQ103QuestScript kmyQuest = __temp as MQ103QuestScript
;END AUTOCAST
;BEGIN CODE
;QuickStart to last room and scene

Alias_PreQuestDungeonDisabler.GetReference().Disable()
SonsAttackEnableMarker.enable()

SetStage(170)

kmyquest.ExteriorAttack.Stop()
kmyquest.ExteriorIntro.Stop()
kmyquest.MQ103aInteriorAttack03.Stop()

Alias_FriendlyFollower01.GetReference().Enable()
Alias_FriendlyFollower02.GetReference().Enable()

Alias_FriendlyFollower01.GetReference().MoveTo(Game.GetPlayer())
Alias_FriendlyFollower02.GetReference().MoveTo(Game.GetPlayer())
Alias_Ralof.GetReference().MoveTo(Game.GetPlayer())
Alias_Galmar.GetReference().MoveTo(Game.GetPlayer())

kmyquest.MQ103aBookRoom.Start()
;END CODE
EndFunction
;END FRAGMENT

;BEGIN FRAGMENT Fragment_19
Function Fragment_19()
;BEGIN AUTOCAST TYPE MQ103QuestScript
Quest __temp = self as Quest
MQ103QuestScript kmyQuest = __temp as MQ103QuestScript
;END AUTOCAST
;BEGIN CODE
;LockedGate01.disable()
;SetObjectiveCompleted(50) ;COMPLETE Find a way to open the gate

;Alias_EnemyEavesdrop01a.GetActorRef().RemoveFromFaction(MQ103DefenderFaction)
;Alias_EnemyEavesdrop01b.GetActorRef().RemoveFromFaction(MQ103DefenderFaction)
;Alias_EnemyEavesdrop01a.GetActorRef().AddToFaction(MQ103DefenderFaction)
;Alias_EnemyEavesdrop01b.GetActorRef().AddToFaction(MQ103DefenderFaction)
;END CODE
EndFunction
;END FRAGMENT

;BEGIN FRAGMENT Fragment_2
Function Fragment_2()
;BEGIN CODE
; start quest on Imperial side
; debug.trace("MQ Quickstart " + self)
; TODO - figure out right MQ102 stages for quickstart
MQ102B.setstage(1)
MQ102B.setstage(80)
MQ102B.setstage(100)
; END TODO
CWStartObj.SetStage(110) ; join Stormcloaks objective complete
setstage(10)
; debug.trace("MQ Quickstart " + self)
;END CODE
EndFunction
;END FRAGMENT

;BEGIN FRAGMENT Fragment_8
Function Fragment_8()
;BEGIN AUTOCAST TYPE MQ103QuestScript
Quest __temp = self as Quest
MQ103QuestScript kmyQuest = __temp as MQ103QuestScript
;END AUTOCAST
;BEGIN CODE
setObjectiveCompleted(10)
; player is sent to Korvanjund
setObjectiveDisplayed(20)
kmyQuest.KorvanjundMapMarker.AddToMap()
; enable friendly soldiers
SonsAttackEnableMarker.enable()
Alias_PreQuestDungeonDisabler.GetReference().Disable()

; move Ralof
If kmyquest.MQ102A.IsRunning()
kmyquest.MQ102A.setStage(52) ;stops the Hadvar Riverwood scene, and prevents it from happening again
endif
If kmyquest. MQ102B.IsRunning()
kmyquest.MQ102B.setStage(52) ;stops the Ralof Riverwood scene, and prevents it from happening again
endif

Alias_Ralof.GetRef().moveto(KorvanjundMeetingPoint)
Alias_Ralof.GetActorRef().AddToFaction(CWSonsFactionNPC)
Alias_Ralof.GetActorRef().SetActorValue("Aggression", 1)
Alias_Ralof.GetActorRef().AddItem(kmyQuest.Warhammer, 1)
Alias_Ralof.GetActorRef().SetOutfit(RalofOutfit)
Alias_Ralof.TryToEnable()
kmyquest.CWs.BuddyDialogueAllowed = true
; TODO everything else necessary to set up Korvanjund...
;RegisterForUpdate(2)
;END CODE
EndFunction
;END FRAGMENT

;END FRAGMENT CODE - Do not edit anything between this and the begin comment

Quest Property MQ102B  Auto  

ObjectReference Property SonsAttackEnableMarker  Auto  

ObjectReference Property KorvanjundMeetingPoint  Auto  

Faction Property TempFriendsFaction  Auto  

Faction Property MQ103DefenderFaction  Auto  

Faction Property PlayerFaction  Auto  

ObjectReference Property LockedGate01  Auto  

Quest Property MQ104B  Auto  

Scene Property GalmarScene  Auto  

Quest Property MQ104A  Auto  

Quest Property MQ103A  Auto  

Quest Property CW  Auto  

Faction Property CWSonsFactionNPC  Auto  

LocationAlias Property KorvanjundReserved  Auto  

Outfit Property RalofOutfit  Auto  

Quest Property CWStartObj  Auto  
